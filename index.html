<!-- PHASE 1â€“3 UNIFIED FUNCTIONALITY -->
<div id="fileSection" style="margin-top: 40px;">
  <label for="industry">Select Industry:</label>
  <select id="industry">
    <option value="">-- Choose an Industry --</option>
    <!-- Include all 50 industries -->
    <option>Accounting</option>
    <option>Advertising</option>
    <option>Agriculture</option>
    <option>Architecture</option>
    <option>Automotive</option>
    <option>Banking</option>
    <option>Beauty</option>
    <option>Construction</option>
    <option>Consulting</option>
    <option>Customer Service</option>
    <option>Data Analytics</option>
    <option>Design</option>
    <option>Education</option>
    <option>Energy</option>
    <option>Engineering</option>
    <option>Entertainment</option>
    <option>Environmental</option>
    <option>Event Planning</option>
    <option>Fashion</option>
    <option>Finance</option>
    <option>Food & Beverage</option>
    <option>Gaming</option>
    <option>Government</option>
    <option>Healthcare</option>
    <option>Hospitality</option>
    <option>Human Resources</option>
    <option>Import/Export</option>
    <option>Insurance</option>
    <option>Legal</option>
    <option>Logistics</option>
    <option>Manufacturing</option>
    <option>Marketing</option>
    <option>Media</option>
    <option>Medical Devices</option>
    <option>Mining</option>
    <option>Non-Profit</option>
    <option>Pharmaceuticals</option>
    <option>Photography</option>
    <option>Publishing</option>
    <option>Real Estate</option>
    <option>Recruiting</option>
    <option>Retail</option>
    <option>Sales</option>
    <option>Security</option>
    <option>Software</option>
    <option>Sports</option>
    <option>Technology</option>
    <option>Telecom</option>
    <option>Transportation</option>
    <option>Travel</option>
  </select>

  <label for="subcategory" style="margin-left: 20px;">Subcategory:</label>
  <select id="subcategory">
    <option value="">-- Select Industry First --</option>
  </select>

  <input type="text" id="customSubcategory" placeholder="Or type a custom subcategory" style="margin-left: 10px;" />

  <br><br>
  <label for="fileUpload">Upload File:</label>
  <input type="file" id="fileUpload" />
  <button class="button" style="background-color: cyan; color: black; font-weight: bold; margin-left: 10px;" onclick="triggerFileReload()">Load File</button>
</div>

<!-- HEADER MAPPING + PREVIEW will be injected here -->
<div id="headerMappingSection" style="display: none; margin-top: 40px;"></div>
<div id="tablePreview" style="display: none; margin-top: 40px;"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// Phase 1: Subcategory handling
const subcategories = {
  "Accounting": ["Payroll", "Tax", "Audit"],
  "Construction": ["Residential", "Commercial", "Industrial"],
  "Retail": ["Fashion", "Electronics", "Groceries"],
  // ... (add more for others)
};

document.getElementById("industry").addEventListener("change", function () {
  const selected = this.value;
  const subcatDropdown = document.getElementById("subcategory");
  subcatDropdown.innerHTML = '<option value="">-- Choose Subcategory --</option>';
  if (subcategories[selected]) {
    subcategories[selected].forEach(sub => {
      const opt = document.createElement("option");
      opt.value = sub;
      opt.textContent = sub;
      subcatDropdown.appendChild(opt);
    });
  }
});

// Phase 2 + 3 Globals
let originalHeaders = [];
let tableData = [];

function triggerFileReload() {
  const fileInput = document.getElementById('fileUpload');
  const file = fileInput.files[0];
  if (!file) {
    alert("Please select a file first.");
    return;
  }
  handleFile({ target: { files: [file] } });
}

function handleFile(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function (evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

    if (!json.length) return alert("Empty sheet.");

    originalHeaders = json[0];
    tableData = json.slice(1).filter(row => row.join("").trim() !== "");
    buildHeaderMapping();
  };
  reader.readAsArrayBuffer(file);
}

function buildHeaderMapping() {
  const container = document.getElementById("headerMappingSection");
  container.innerHTML = "<h2>Set Column Headers</h2>";

  const fieldBox = document.createElement("div");
  originalHeaders.forEach((header, index) => {
    const wrapper = document.createElement("div");
    wrapper.style.marginBottom = "15px";

    const label = document.createElement("label");
    label.textContent = `Column ${index + 1} (${header || "Unnamed"})`;

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Enter custom label or leave as is";
    input.value = header || "";
    input.dataset.index = index;
    input.style.marginLeft = "10px";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = true;
    checkbox.dataset.index = index;
    checkbox.style.marginLeft = "10px";

    const span = document.createElement("span");
    span.textContent = " Include column";

    wrapper.appendChild(label);
    wrapper.appendChild(input);
    wrapper.appendChild(checkbox);
    wrapper.appendChild(span);

    fieldBox.appendChild(wrapper);
  });

  const previewBtn = document.createElement("button");
  previewBtn.textContent = "Preview Table";
  previewBtn.className = "button";
  previewBtn.style.backgroundColor = "cyan";
  previewBtn.onclick = buildTablePreview;

  container.appendChild(fieldBox);
  container.appendChild(previewBtn);
  container.style.display = "block";
}

function buildTablePreview() {
  const container = document.getElementById("tablePreview");
  const preview = document.createElement("div");
  const rows = [];

  const checkboxes = document.querySelectorAll("#headerMappingSection input[type='checkbox']");
  const inputs = document.querySelectorAll("#headerMappingSection input[type='text']");

  const includedIndexes = [];
  const labels = [];

  checkboxes.forEach((box, i) => {
    if (box.checked) {
      includedIndexes.push(i);
      labels.push(inputs[i].value || `Column ${i + 1}`);
    }
  });

  const table = document.createElement("table");
  table.style.width = "100%";
  table.style.borderCollapse = "collapse";
  table.style.marginTop = "20px";
  table.style.backgroundColor = "#F5F5DC";

  const thead = document.createElement("thead");
  const trHead = document.createElement("tr");
  labels.forEach(label => {
    const th = document.createElement("th");
    th.textContent = label;
    th.style.padding = "10px";
    th.style.border = "1px solid #aaa";
    th.style.backgroundColor = "#00E5FF";
    th.style.color = "#000";
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  tableData.forEach((row, r) => {
    const tr = document.createElement("tr");
    tr.style.backgroundColor = r % 2 === 0 ? "#fff" : "#eef9fb";
    includedIndexes.forEach(i => {
      const td = document.createElement("td");
      td.textContent = row[i] ?? "";
      td.style.padding = "8px";
      td.style.border = "1px solid #ccc";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  preview.appendChild(table);

  container.innerHTML = "<h2>Preview Table</h2>";
  container.appendChild(preview);
  container.style.display = "block";
}
</script>
