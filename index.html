<!-- Phase 1: Upload and Parse -->
<div id="phase1-container" style="margin-bottom: 20px;">
  <h2 style="color: #F5F5DC; font-size: 1.8rem; margin-bottom: 15px;">Phase 1 â€“ Upload Your File</h2>
  <input type="file" id="fileUpload" accept=".xlsx, .csv" style="width: 100%; max-width: 400px; padding: 8px; margin-bottom: 10px; border-radius: 6px; border: none; font-size: 1rem;"/>
  <button id="loadButton" style="background-color: #00E5FF; color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 6px;">Add/Replace</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
let phase1JsonData = []; // Store parsed data for Phase 2

document.getElementById('loadButton').addEventListener('click', () => {
  const fileInput = document.getElementById('fileUpload');
  if (!fileInput.files.length) {
    alert("Please select a file first.");
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = function(evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

    if (jsonData.length === 0) {
      alert("Empty sheet.");
      return;
    }

    // Store data for phase 2
    phase1JsonData = jsonData;

    // ðŸš€ Trigger Phase 2
    renderHeaderMappingPhase2(jsonData[0], jsonData.slice(1));
  };
  reader.readAsArrayBuffer(file);
});
</script>
<!-- Phase 1: File upload and JSON parsing only -->
<div id="phase1-container" style="margin-bottom: 20px;">
  <h2>Phase 1 â€“ Upload Your File</h2>
  <input type="file" id="fileUpload" accept=".xlsx, .csv" />
  <button id="loadButton">Add/Replace</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
let phase1JsonData = []; // Store parsed data for phase 2

document.getElementById('loadButton').addEventListener('click', () => {
  const fileInput = document.getElementById('fileUpload');
  if (!fileInput.files.length) {
    alert("Please select a file.");
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = function(evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

    if (jsonData.length === 0) {
      alert("Empty sheet.");
      return;
    }

    // Store data for phase 2
    phase1JsonData = jsonData;

    // ðŸŽ¯ Automatically trigger Phase 2 mapping!
    renderHeaderMappingPhase2(jsonData[0], jsonData.slice(1));
  };
  reader.readAsArrayBuffer(file);
});
</script>
<!-- Phase 2: Clean Dynamic Header Mapping Only -->
<div id="headerMappingContainer"></div>
<div id="tablePreview" style="margin-top: 20px;"></div>

<script>
const popularHeaders = ["Name", "Email", "Phone", "Date", "Amount", "Service Type", "Status", "Notes", "Location"];

function renderHeaderMappingPhase2(headers, rows) {
  const container = document.createElement("div");
  container.style.marginTop = "10px";

  headers.forEach((header, index) => {
    const wrapper = document.createElement("div");
    wrapper.style.marginBottom = "10px";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = true;
    checkbox.style.marginRight = "6px";

    const note = document.createElement("span");
    note.textContent = "Uncheck to hide this column";
    note.style.fontSize = "0.85rem";
    note.style.color = "#ccc";
    wrapper.appendChild(checkbox);
    wrapper.appendChild(note);

    const select = document.createElement("select");
    select.style.width = "100%";
    select.style.marginTop = "4px";
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "-- Choose or type your own --";
    select.appendChild(defaultOption);

    popularHeaders.forEach(h => {
      const opt = document.createElement("option");
      opt.value = h;
      opt.textContent = h;
      select.appendChild(opt);
    });

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Or enter custom label";
    input.style.width = "100%";
    input.style.marginTop = "4px";

    wrapper.appendChild(select);
    wrapper.appendChild(input);
    container.appendChild(wrapper);
  });

  const previewButton = document.createElement("button");
  previewButton.textContent = "Preview Table";
  previewButton.style.marginTop = "10px";
  previewButton.style.backgroundColor = "#00E5FF";
  previewButton.style.color = "#000";
  previewButton.style.padding = "8px 16px";
  previewButton.style.border = "none";
  previewButton.style.borderRadius = "6px";
  previewButton.style.cursor = "pointer";
  previewButton.onclick = () => previewTable(headers, rows, container);

  container.appendChild(previewButton);

  document.getElementById("headerMappingContainer").innerHTML = "";
  document.getElementById("headerMappingContainer").appendChild(container);
}

function previewTable(headers, rows, headerContainer) {
  const checkboxes = headerContainer.querySelectorAll("input[type='checkbox']");
  const selects = headerContainer.querySelectorAll("select");
  const inputs = headerContainer.querySelectorAll("input[type='text']");

  const finalHeaders = [];
  const visibleIndexes = [];

  checkboxes.forEach((cb, i) => {
    if (cb.checked) {
      const customLabel = inputs[i].value.trim();
      const selected = selects[i].value;
      finalHeaders.push(customLabel || selected || headers[i]);
      visibleIndexes.push(i);
    }
  });

  const table = document.createElement("table");
  table.style.width = "100%";
  table.style.borderCollapse = "collapse";
  table.style.marginTop = "10px";
  table.style.backgroundColor = "#f5f5f5";
  table.style.color = "#000";

  const thead = document.createElement("thead");
  const trHead = document.createElement("tr");
  finalHeaders.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    th.style.padding = "8px";
    th.style.backgroundColor = "#00E5FF";
    th.style.border = "1px solid #ccc";
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  rows.forEach((row, rIndex) => {
    const tr = document.createElement("tr");
    tr.style.backgroundColor = rIndex % 2 === 0 ? "#e0e0e0" : "#f5f5f5";
    visibleIndexes.forEach(i => {
      const td = document.createElement("td");
      td.textContent = row[i] || "";
      td.style.padding = "6px";
      td.style.border = "1px solid #ccc";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);

  const previewContainer = document.getElementById("tablePreview");
  previewContainer.innerHTML = "";
  previewContainer.appendChild(table);
}
</script>
