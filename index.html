<!-- Phase 1: Upload and Parse -->
<div id="phase1-container" style="margin-bottom: 20px;">
  <h2 style="color: #F5F5DC; font-size: 1.8rem;">Phase 1 – Upload Your File</h2>
  <input type="file" id="fileUpload" accept=".xlsx, .csv" style="width: 100%; max-width: 400px; padding: 8px; margin-top: 10px; border-radius: 6px; border: none; font-size: 1rem;"/>
  <button id="loadButton" style="background-color: #00E5FF; color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 6px;">Add/Replace</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
let parsedDataPhase1 = [];

document.getElementById('loadButton').addEventListener('click', () => {
  const fileInput = document.getElementById('fileUpload');
  if (!fileInput.files.length) {
    alert("Please select a file first.");
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = function(evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

    if (jsonData.length === 0) {
      alert("Empty sheet.");
      return;
    }

    parsedDataPhase1 = jsonData;
    renderPhase2(jsonData[0], jsonData.slice(1));
  };
  reader.readAsArrayBuffer(file);
});
</script>
<!-- Phase 2: Column Mapping -->
<div id="phase2-container" style="margin-top: 30px;">
  <h2 style="color: #F5F5DC; font-size: 1.8rem;">Phase 2 – Map Your Columns</h2>
  <div id="headerMappings"></div>
  <button id="previewButton" style="background-color: #00E5FF; color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px;">Preview Table</button>
  <div id="previewTable" style="margin-top: 20px;"></div>
</div>

<script>
function renderPhase2(headers, rows) {
  const container = document.getElementById('headerMappings');
  container.innerHTML = "";

  headers.forEach((header, i) => {
    const wrapper = document.createElement("div");
    wrapper.style.marginBottom = "10px";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = true;
    checkbox.style.marginRight = "6px";

    const message = document.createElement("span");
    message.textContent = "Uncheck to hide this column";

    const select = document.createElement("select");
    ["Client Name", "Service Date", "Amount", "Status", "Notes"].forEach(option => {
      const opt = document.createElement("option");
      opt.value = option;
      opt.textContent = option;
      select.appendChild(opt);
    });
    select.style.marginLeft = "10px";

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Or enter custom label";
    input.style.marginLeft = "10px";
    input.style.padding = "4px";
    input.style.width = "200px";

    wrapper.appendChild(checkbox);
    wrapper.appendChild(message);
    wrapper.appendChild(select);
    wrapper.appendChild(input);
    container.appendChild(wrapper);
  });

  document.getElementById('previewButton').onclick = () => {
    const finalHeaders = [];
    const finalRows = [];

    const wrappers = container.querySelectorAll("div");
    wrappers.forEach((wrapper, i) => {
      const checkbox = wrapper.querySelector("input[type=checkbox]");
      if (!checkbox.checked) return;

      const select = wrapper.querySelector("select");
      const input = wrapper.querySelector("input[type=text]");
      const label = input.value.trim() || select.value || `Column ${i+1}`;
      finalHeaders.push(label);
    });

    rows.forEach(row => {
      const filteredRow = [];
      wrappers.forEach((wrapper, i) => {
        const checkbox = wrapper.querySelector("input[type=checkbox]");
        if (checkbox.checked) {
          filteredRow.push(row[i] || "");
        }
      });
      finalRows.push(filteredRow);
    });

    renderPreviewTable(finalHeaders, finalRows);
  };
}

function renderPreviewTable(headers, rows) {
  const container = document.getElementById('previewTable');
  container.innerHTML = "";

  const table = document.createElement("table");
  table.style.width = "100%";
  table.style.borderCollapse = "collapse";
  table.style.backgroundColor = "#F5F5DC";
  table.style.color = "#000";

  const thead = document.createElement("thead");
  const trHead = document.createElement("tr");
  headers.forEach(header => {
    const th = document.createElement("th");
    th.textContent = header;
    th.style.padding = "8px";
    th.style.backgroundColor = "#00E5FF";
    th.style.color = "#000";
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  rows.forEach((row, rIndex) => {
    const tr = document.createElement("tr");
    tr.style.backgroundColor = rIndex % 2 === 0 ? "#f0f0f0" : "#e0e0e0";
    row.forEach(cell => {
      const td = document.createElement("td");
      td.textContent = cell;
      td.style.padding = "6px";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  container.appendChild(table);
}
</script>
