<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SheetPilot</title>
  <style>
    body {
      background-color: #1C1C2A;
      color: #F5F5DC;
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      margin: 0;
    }

    h1, h2 {
      font-size: 2em;
      color: #F5F5DC;
    }

    label {
      font-weight: bold;
      margin-top: 20px;
      display: block;
    }

    select, input[type="text"], input[type="file"] {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      margin-top: 6px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
      box-sizing: border-box;
    }

    button {
      background-color: #00E5FF;
      color: #000;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background-color: #00CCE0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th {
      background-color: #00E5FF;
      color: #000;
      padding: 10px;
    }

    td {
      padding: 8px;
      border-top: 1px solid #444;
    }

    tr:nth-child(even) {
      background-color: #232338;
    }

    tr:nth-child(odd) {
      background-color: #1C1C2A;
    }

    .filter-input {
      padding: 8px;
      margin-bottom: 10px;
      margin-right: 10px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
      width: 180px;
    }
  </style>
</head>
<body>
  <h1>SheetPilot</h1>

  <label for="industry">Select Industry:</label>
  <select id="industry" onchange="updateSubcategories()">
    <option value="">-- Choose an Industry --</option>
    <option>Retail</option>
    <option>Transportation</option>
    <option>Finance</option>
    <option>Education</option>
    <option>Healthcare</option>
    <option>Construction</option>
    <option>Small Business</option>
    <option>Consulting</option>
    <option>Publishing</option>
    <option>Real Estate</option>
    <option>Legal</option>
    <option>Hospitality</option>
    <option>Manufacturing</option>
    <option>Insurance</option>
    <option>Marketing & Advertising</option>
    <option>Entertainment</option>
    <option>Technology</option>
    <option>Food & Beverage</option>
    <option>Fitness</option>
    <option>Childcare</option>
    <option>Landscaping</option>
    <option>E-commerce</option>
    <option>Plumbing</option>
    <option>Electrician</option>
    <option>Auto Repair</option>
    <option>Security Services</option>
    <option>Courier Services</option>
    <option>Barber/Salon</option>
    <option>Photography</option>
    <option>Event Planning</option>
    <option>Accounting</option>
    <option>Veterinary</option>
    <option>HR Services</option>
    <option>Travel Services</option>
    <option>Copywriting</option>
    <option>Interior Design</option>
    <option>IT Support</option>
    <option>Printing Services</option>
    <option>Pet Grooming</option>
    <option>Roofing</option>
    <option>HVAC</option>
    <option>Painting</option>
  </select>

  <label for="subcategory">Subcategory:</label>
  <select id="subcategory">
    <option value="">-- Select Industry First --</option>
  </select>

  <input type="text" id="customIndustry" placeholder="Or type a custom subcategory" />

  <label for="fileUpload">Upload File:</label>
  <input type="file" id="fileUpload" />
  <button onclick="triggerFileReload()">Load File</button>

  <p style="color: gray; font-size: 0.9em;">Use this to upload additional data to the current table.</p>

  <div id="headerMappingSection" style="display:none;">
    <h2>Set Column Headers</h2>
    <div id="headerFields"></div>
    <button onclick="resetMapping()">Reset Mapping</button>
    <button onclick="previewTable()">Preview Table</button>
  </div>

  <div id="simpleFilters" style="display:none; margin-top: 20px;">
    <h2>Simple Filters</h2>
    <div id="filterInputs"></div>
  </div>

  <div id="tablePreview" style="display:none;">
    <h2>Preview Table</h2>
    <div id="previewContainer"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const subcategoryOptions = {
      "Retail": ["Clothing", "Electronics", "Convenience Store"],
      "Transportation": ["Trucking", "Fleet Management"],
      "Finance": ["Bookkeeping", "CPA", "Investments"],
      "Education": ["Tutor", "Private Instructor", "School Admin"],
      "Healthcare": ["Nursing", "Dental", "Home Health"],
      "Construction": ["Residential", "Commercial", "Remodeling"],
      "Small Business": ["Lawn Care", "Cleaning", "Freelance"]
    };

    const suggestedHeaders = {
      "Retail": ["Product Name", "SKU", "Price", "Quantity", "Category"],
      "Finance": ["Client", "Account Type", "Balance", "Transaction Date", "Amount"],
      "Transportation": ["Driver", "Vehicle", "Route", "Date", "Distance"]
    };

    let originalHeaders = [];
    let tableData = [];
    let industryPicked = "";

    document.getElementById('industry').addEventListener('change', function () {
      industryPicked = this.value;
      updateSubcategories();
    });

    function updateSubcategories() {
      const sub = document.getElementById("subcategory");
      const selected = subcategoryOptions[industryPicked] || [];
      sub.innerHTML = '<option value="">-- Choose Subcategory --</option>';
      selected.forEach(opt => {
        const o = document.createElement("option");
        o.textContent = o.value = opt;
        sub.appendChild(o);
      });
    }

    function triggerFileReload() {
      const fileInput = document.getElementById('fileUpload');
      const file = fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        if (json.length === 0) {
          alert("Empty sheet.");
          return;
        }

        const newHeaders = json[0];
        const newRows = json.slice(1).filter(row => row.join("").trim() !== "");

        if (originalHeaders.length === 0) {
          originalHeaders = newHeaders;
          tableData = newRows;
        } else {
          const append = confirm("Append this data to your current table?");
          if (append) {
            if (JSON.stringify(originalHeaders) !== JSON.stringify(newHeaders)) {
              alert("Headers don't match. Cannot append.");
              return;
            }
            tableData = [...tableData, ...newRows];
          } else {
            originalHeaders = newHeaders;
            tableData = newRows;
          }
        }

        showHeaderMapping(originalHeaders);
        fileInput.value = "";
      };
      reader.readAsArrayBuffer(file);
    }

    function resetMapping() {
      document.getElementById("headerFields").innerHTML = "";
      document.getElementById("previewContainer").innerHTML = "";
      document.getElementById("headerMappingSection").style.display = "none";
      document.getElementById("tablePreview").style.display = "none";
      document.getElementById("simpleFilters").style.display = "none";
    }

    function showHeaderMapping(headers) {
      const container = document.getElementById("headerFields");
      container.innerHTML = "";
      const suggestions = suggestedHeaders[industryPicked] || [];

      headers.forEach((header, i) => {
        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "15px";

        const label = document.createElement("label");
        label.textContent = `Column ${i + 1}`;

        const select = document.createElement("select");
        select.dataset.index = i;
        const blank = document.createElement("option");
        blank.value = "";
        blank.textContent = "-- Choose or type your own --";
        select.appendChild(blank);
        suggestions.forEach(s => {
          const option = document.createElement("option");
          option.value = s;
          option.textContent = s;
          select.appendChild(option);
        });

        const manual = document.createElement("input");
        manual.type = "text";
        manual.placeholder = "Or enter custom label";
        manual.dataset.index = i;

        const includeBox = document.createElement("input");
        includeBox.type = "checkbox";
        includeBox.checked = true;
        includeBox.id = `include-${i}`;

        const includeLabel = document.createElement("label");
        includeLabel.textContent = " Include this column";
        includeLabel.style.marginLeft = "6px";

        wrapper.appendChild(label);
        wrapper.appendChild(select);
        wrapper.appendChild(manual);
        wrapper.appendChild(includeBox);
        wrapper.appendChild(includeLabel);
        container.appendChild(wrapper);
      });

      document.getElementById("headerMappingSection").style.display = "block";
    }

    function previewTable() {
      const selects = document.querySelectorAll("#headerFields select");
      const inputs = document.querySelectorAll("#headerFields input[type='text']");
      const checkboxes = document.querySelectorAll("#headerFields input[type='checkbox']");

      const headers = [];
      const includedIndexes = [];

      selects.forEach((select, i) => {
        const manualValue = inputs[i].value.trim();
        const useColumn = checkboxes[i].checked;
        if (!useColumn) return;
        includedIndexes.push(i);
        headers.push(manualValue || select.value || `Column ${i + 1}`);
      });

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      tableData.forEach(row => {
        const tr = document.createElement("tr");
        includedIndexes.forEach(i => {
          const td = document.createElement("td");
          td.textContent = row[i] ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      const container = document.getElementById("previewContainer");
      container.innerHTML = "";
      container.appendChild(table);

      // Filter Inputs
      const filterDiv = document.getElementById("filterInputs");
      filterDiv.innerHTML = "";
      headers.forEach((h, idx) => {
        const input = document.createElement("input");
        input.placeholder = `Filter ${h}`;
        input.className = "filter-input";
        input.addEventListener("input", () => {
          const filtered = tableData.filter(row => {
            return includedIndexes.every((i, j) => {
              const filter = document.querySelectorAll(".filter-input")[j].value.toLowerCase();
              return (row[i] ?? "").toString().toLowerCase().includes(filter);
            });
          });
          renderFilteredTable(headers, includedIndexes, filtered);
        });
        filterDiv.appendChild(input);
      });

      document.getElementById("simpleFilters").style.display = "block";
      document.getElementById("tablePreview").style.display = "block";
    }

    function renderFilteredTable(headers, indexes, rows) {
      const container = document.getElementById("previewContainer");
      const table = document.createElement("table");

      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      rows.forEach(row => {
        const tr = document.createElement("tr");
        indexes.forEach(i => {
          const td = document.createElement("td");
          td.textContent = row[i] ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.innerHTML = "";
      container.appendChild(table);
    }
  </script>
</body>
</html>
