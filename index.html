<!-- Phase 2: Header Mapping + Preview -->
<div id="headerMappingSection" style="display: none; margin-top: 40px;">
  <h2>Set Column Headers</h2>
  <div id="headerFields"></div>
  <button class="button" onclick="resetMapping()">Reset Mapping</button>
  <div style="font-size: 0.85em; color: #aaa; margin-top: 4px; margin-bottom: 20px;">
    Use this to reset the header mapping if you change your industry or subcategory.
  </div>
  <button class="button" onclick="previewTable()">Preview Table</button>
  <p style="color: gray; font-size: 0.9em; margin-top: 5px;">
    Tip: If you uncheck or change any column headers, click “Preview Table” again to refresh the table below.
  </p>
  <button class="button" onclick="triggerLoadOptions()">Load File</button>
  <p style="color: gray; font-size: 0.9em; margin-top: 5px;">
    Use this to upload another file with similar data under the same industry setup.
  </p>
</div>

<div id="tablePreview" style="margin-top: 40px; display: none;">
  <h2>Preview Table</h2>
  <div id="previewContainer" style="overflow-x: auto;"></div>
</div>

<!-- Modal -->
<div id="loadModal" style="display: none; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -30%); background: #1C1C2A; color: #F5F5DC; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.5); z-index: 1000;">
  <h3>Upload Another File</h3>
  <p>How do you want to handle the new file?</p>
  <input type="file" id="additionalFile" accept=".xlsx, .csv" style="margin-bottom: 10px;" />
  <div style="margin-top: 10px;">
    <button class="button" onclick="handleAdditionalFile('append')">Append to Current Table</button>
    <button class="button" onclick="handleAdditionalFile('replace')">Start New Table</button>
    <button class="button" onclick="document.getElementById('loadModal').style.display='none'">Cancel</button>
  </div>
</div>

<!-- Load XLSX library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
  const suggestedHeaders = {
    "Small Business": ["Customer Name", "Phone", "Email", "Service Type", "Amount", "Date", "Notes"],
    "Real Estate": ["Client Name", "Property Address", "Agent", "Contract Type", "Closing Date", "Commission"],
    "Healthcare": ["Patient Name", "DOB", "Service Date", "Procedure", "Billing Code", "Amount"],
    "Construction": ["Project", "Location", "Foreman", "Start Date", "End Date", "Total Cost"]
  };

  let originalHeaders = [];
  let tableData = [];
  let industryPicked = "";

  document.getElementById('industry').addEventListener('change', function () {
    industryPicked = this.value;
  });

  function triggerLoadOptions() {
    document.getElementById('loadModal').style.display = 'block';
  }

  function resetMapping() {
    document.getElementById("headerMappingSection").style.display = "none";
    document.getElementById("tablePreview").style.display = "none";
    document.getElementById("previewContainer").innerHTML = "";
    document.getElementById("headerFields").innerHTML = "";
    originalHeaders = [];
    tableData = [];
  }

  function handleAdditionalFile(mode) {
    const file = document.getElementById("additionalFile").files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(evt) {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

      if (json.length === 0) {
        alert("Empty sheet.");
        return;
      }

      const newHeaders = json[0];
      const newData = json.slice(1).filter(row => row.join("").trim() !== "");

      if (mode === 'replace') {
        originalHeaders = newHeaders;
        tableData = newData;
        showHeaderMapping(newHeaders);
      } else if (mode === 'append') {
        tableData = tableData.concat(newData);
        previewTable(); // just re-renders
      }

      document.getElementById("loadModal").style.display = "none";
    };
    reader.readAsArrayBuffer(file);
  }

  function showHeaderMapping(headers) {
    const container = document.getElementById("headerFields");
    container.innerHTML = "";

    const suggestions = suggestedHeaders[industryPicked] || [];

    headers.forEach((header, i) => {
      const wrapper = document.createElement("div");
      wrapper.style.marginBottom = "15px";

      const label = document.createElement("label");
      label.textContent = `Column ${i + 1} (${header || "Unnamed"})`;

      const select = document.createElement("select");
      select.style.width = "100%";
      select.style.padding = "10px";
      select.style.borderRadius = "6px";
      select.dataset.index = i;

      const blank = document.createElement("option");
      blank.value = "";
      blank.textContent = "-- Choose or type your own --";
      select.appendChild(blank);

      suggestions.forEach(s => {
        const option = document.createElement("option");
        option.value = s;
        option.textContent = s;
        select.appendChild(option);
      });

      const manualInput = document.createElement("input");
      manualInput.type = "text";
      manualInput.placeholder = "Or enter a custom label";
      manualInput.style.marginTop = "6px";
      manualInput.style.width = "100%";
      manualInput.dataset.index = i;

      const includeBox = document.createElement("input");
      includeBox.type = "checkbox";
      includeBox.checked = true;
      includeBox.id = `include-${i}`;

      const includeLabel = document.createElement("label");
      includeLabel.textContent = " Include this column";
      includeLabel.style.marginLeft = "6px";
      includeLabel.style.fontWeight = "bold";
      includeLabel.style.display = "block";

      const helper = document.createElement("div");
      helper.textContent = "Uncheck this to exclude this column from the table and export.";
      helper.style.color = "gray";
      helper.style.fontSize = "0.85em";
      helper.style.marginTop = "3px";

      wrapper.appendChild(label);
      wrapper.appendChild(select);
      wrapper.appendChild(manualInput);
      wrapper.appendChild(includeBox);
      wrapper.appendChild(includeLabel);
      wrapper.appendChild(helper);

      container.appendChild(wrapper);
    });

    document.getElementById("headerMappingSection").style.display = "block";
  }

  function previewTable() {
    const selects = document.querySelectorAll("#headerFields select");
    const inputs = document.querySelectorAll("#headerFields input[type='text']");
    const checkboxes = document.querySelectorAll("#headerFields input[type='checkbox']");

    const headers = [];
    const includedIndexes = [];

    selects.forEach((select, i) => {
      const manualValue = inputs[i].value.trim();
      const useColumn = checkboxes[i].checked;

      if (!useColumn) return;

      includedIndexes.push(i);
      headers.push(manualValue || select.value || `Column ${i + 1}`);
    });

    const table = document.createElement("table");
    table.style.width = "100%";
    table.style.borderCollapse = "collapse";
    table.style.backgroundColor = "#1C1C2A";
    table.style.color = "#F5F5DC";
    table.style.fontSize = "0.95em";

    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");

    headers.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      th.style.backgroundColor = "#00E5FF";
      th.style.color = "#000";
      th.style.padding = "10px";
      headerRow.appendChild(th);
    });

    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    tableData.forEach((row, rIndex) => {
      const tr = document.createElement("tr");
      tr.style.backgroundColor = rIndex % 2 === 0 ? "#232338" : "#1C1C2A";

      includedIndexes.forEach(i => {
        const td = document.createElement("td");
        td.textContent = row[i] ?? "";
        td.style.padding = "8px";
        td.style.wordBreak = "break-word";
        td.style.borderTop = "1px solid #444";
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);

    const container = document.getElementById("previewContainer");
    container.innerHTML = "";
    container.appendChild(table);
    document.getElementById("tablePreview").style.display = "block";
  }
</script>
