<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SheetPilot</title>
  <style>
    body {
      background-color: #1C1C2A;
      color: #F5F5DC;
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      margin: 0;
    }
    h1 {
      font-size: 2.5em;
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
      margin-top: 20px;
      display: block;
    }
    select, input[type="text"], input[type="file"] {
      width: 100%;
      max-width: 420px;
      padding: 10px;
      margin-top: 5px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
    }
    .button {
      background-color: #00E5FF;
      color: #000;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      margin-top: 20px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s ease;
    }
    .button:hover {
      background-color: #00cce0;
    }
    .tip {
      color: #ccc;
      font-size: 0.85em;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>SheetPilot</h1>

  <!-- PHASE 1 -->
  <label for="industry">Select Your Industry</label>
  <select id="industry" onchange="updateSubcategories()">
    <option value="">-- Choose Industry --</option>
    <option>Finance</option>
    <option>Construction</option>
    <option>Healthcare</option>
    <option>Retail</option>
    <option>Publishing</option>
    <!-- Add all industries you want -->
  </select>

  <label for="subcategory">Subcategory</label>
  <select id="subcategory">
    <option value="">-- Choose Subcategory --</option>
  </select>

  <input type="text" id="customIndustry" placeholder="Or enter your business type" />

  <label for="fileUpload">Upload Your File</label>
  <input type="file" id="fileUpload" accept=".xlsx, .csv" />

  <button class="button" onclick="handleLoad()">Load File</button>
  <div class="tip">Use this to upload additional data to the current table.</div>

  <!-- PHASE 2 -->
  <div id="headerMappingSection" style="display: none; margin-top: 40px;">
    <h2>Set Column Headers</h2>
    <div id="headerFields"></div>
    <button class="button" onclick="previewTable()">Preview Table</button>
    <div class="tip">Tip: If you make changes, click "Preview Table" again to see the update.</div>
  </div>

  <div id="tablePreview" style="margin-top: 40px; display: none;">
    <h2>Preview Table</h2>
    <div id="previewContainer" style="overflow-x: auto;"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const subcategoryOptions = {
      "Finance": ["Bookkeeping", "CPA", "Advisory Services"],
      "Construction": ["Residential", "Commercial", "Remodeling", "Roofing"],
      "Healthcare": ["Home Care", "Nursing", "Dental Office"],
      "Retail": ["Clothing", "Electronics"],
      "Publishing": ["Blog", "Magazine"]
    };

    const suggestedHeaders = {
      "Finance": ["Client", "Amount", "Invoice", "Due Date"],
      "Construction": ["Project", "Location", "Foreman", "Start Date", "End Date", "Total Cost"],
      "Healthcare": ["Patient Name", "Service", "Date", "Amount"],
      "Retail": ["Product", "Price", "Quantity", "Date Sold"],
      "Publishing": ["Author", "Title", "Date", "Category"]
    };

    function updateSubcategories() {
      const industry = document.getElementById("industry").value;
      const sub = document.getElementById("subcategory");
      sub.innerHTML = '<option value="">-- Choose Subcategory --</option>';
      if (subcategoryOptions[industry]) {
        subcategoryOptions[industry].forEach(s => {
          const o = document.createElement("option");
          o.value = s;
          o.textContent = s;
          sub.appendChild(o);
        });
      }
    }

    let originalHeaders = [];
    let tableData = [];
    let industryPicked = "";

    document.getElementById('industry').addEventListener('change', function () {
      industryPicked = this.value;
    });

    document.getElementById('fileUpload').addEventListener('change', handleFile);

    function handleLoad() {
      if (tableData.length > 0) {
        const append = confirm("Would you like to add this data to the current table?");
        if (!append) {
          originalHeaders = [];
          tableData = [];
          document.getElementById("previewContainer").innerHTML = "";
        }
      }
    }

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        if (!json.length) return alert("Empty sheet.");
        originalHeaders = json[0];
        const rows = json.slice(1).filter(row => row.join("").trim() !== "");
        tableData = tableData.concat(rows);
        showHeaderMapping(originalHeaders);
      };
      reader.readAsArrayBuffer(file);
    }

    function showHeaderMapping(headers) {
      const container = document.getElementById("headerFields");
      container.innerHTML = "";
      const suggestions = suggestedHeaders[industryPicked] || [];

      headers.forEach((header, i) => {
        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "15px";

        const label = document.createElement("label");
        label.textContent = `Column ${i + 1} (${header || "Unnamed"})`;

        const select = document.createElement("select");
        select.style.width = "100%";
        select.style.padding = "10px";
        select.style.borderRadius = "6px";
        select.dataset.index = i;

        const blank = document.createElement("option");
        blank.value = "";
        blank.textContent = "-- Choose or type your own --";
        select.appendChild(blank);

        suggestions.forEach(s => {
          const option = document.createElement("option");
          option.value = s;
          option.textContent = s;
          select.appendChild(option);
        });

        const manualInput = document.createElement("input");
        manualInput.type = "text";
        manualInput.placeholder = "Or enter a custom label";
        manualInput.style.marginTop = "6px";
        manualInput.style.width = "100%";
        manualInput.dataset.index = i;

        const includeBox = document.createElement("input");
        includeBox.type = "checkbox";
        includeBox.checked = true;
        includeBox.id = `include-${i}`;
        includeBox.style.marginTop = "10px";

        const includeLabel = document.createElement("label");
        includeLabel.innerHTML = "<strong> Include this column</strong><br><span style='font-size: 0.85em; color: #ccc;'>Uncheck this to exclude this column from the table and export.</span>";
        includeLabel.style.marginLeft = "6px";

        wrapper.appendChild(label);
        wrapper.appendChild(select);
        wrapper.appendChild(manualInput);
        wrapper.appendChild(includeBox);
        wrapper.appendChild(includeLabel);
        container.appendChild(wrapper);
      });

      document.getElementById("headerMappingSection").style.display = "block";
    }

    function previewTable() {
      const selects = document.querySelectorAll("#headerFields select");
      const inputs = document.querySelectorAll("#headerFields input[type='text']");
      const checkboxes = document.querySelectorAll("#headerFields input[type='checkbox']");

      const headers = [];
      const includedIndexes = [];

      selects.forEach((select, i) => {
        const manualValue = inputs[i].value.trim();
        if (!checkboxes[i].checked) return;
        includedIndexes.push(i);
        headers.push(manualValue || select.value || `Column ${i + 1}`);
      });

      const table = document.createElement("table");
      table.style.width = "100%";
      table.style.borderCollapse = "collapse";
      table.style.backgroundColor = "#1C1C2A";
      table.style.color = "#F5F5DC";
      table.style.fontSize = "0.95em";

      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");

      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        th.style.backgroundColor = "#00E5FF";
        th.style.color = "#000";
        th.style.padding = "10px";
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      tableData.forEach((row, rIndex) => {
        const tr = document.createElement("tr");
        tr.style.backgroundColor = rIndex % 2 === 0 ? "#232338" : "#1C1C2A";

        includedIndexes.forEach(i => {
          const td = document.createElement("td");
          td.textContent = row[i] ?? "";
          td.style.padding = "8px";
          td.style.wordBreak = "break-word";
          td.style.borderTop = "1px solid #444";
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);

      const container = document.getElementById("previewContainer");
      container.innerHTML = "";
      container.appendChild(table);
      document.getElementById("tablePreview").style.display = "block";
    }
  </script>
</body>
</html>
